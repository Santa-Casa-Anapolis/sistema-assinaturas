# üìã AN√ÅLISE DO FLUXO DE ASSINATURAS

Data: 2025-01-29
Autor: Cursor AI Assistant

---

## üîç PONTO 1: PERSIST√äNCIA DAS ASSINATURAS AP√ìS DEPLOY

### ‚úÖ Status Atual

O arquivo `docker-compose.yml` est√° configurado com bind mount:
```yaml
volumes:
  - /var/lib/sistema-assinaturas/uploads:/app/uploads
```

**Localiza√ß√£o:** Linha 41 do `docker-compose.yml`

### ‚ö†Ô∏è Problemas Identificados

1. **Ambiente multi-n√≥ do Docker Swarm:**
   - O bind mount aponta para um caminho espec√≠fico do host (`/var/lib/sistema-assinaturas/uploads`)
   - Se o Swarm distribuir containers em m√∫ltiplos n√≥s, o arquivo n√£o estar√° dispon√≠vel em todos eles
   - O servi√ßo `backend` tem `replicas: 1` configurado, mas sem `placement.constraints`

2. **Aus√™ncia de placement constraints:**
   - Atualmente n√£o h√° garantia de que o backend sempre rode no mesmo n√≥
   - Um restart do container pode ser escalonado para outro n√≥

### üîß Solu√ß√µes Recomendadas

#### **OP√á√ÉO A: Placement Constraint (Recomendada para ambiente single-node)**

Adicionar constraint no `docker-compose.yml`:

```yaml
backend:
  # ... configura√ß√£o existente ...
  deploy:
    replicas: 1
    placement:
      constraints:
        - node.hostname == servdocker  # Substitua pelo hostname real do servidor
    restart_policy:
      condition: any
```

**Vantagens:**
- ‚úÖ Simples de implementar
- ‚úÖ Funciona bem em ambientes single-node
- ‚úÖ N√£o requer storage compartilhado

**Desvantagens:**
- ‚ö†Ô∏è Quebra se o container tentar rodar em outro n√≥
- ‚ö†Ô∏è Lista hardcoded de hostnames

#### **OP√á√ÉO B: Storage Compartilhado (Recomendada para multi-node)**

Trocar bind mount por volume compartilhado (NFS, GlusterFS, etc):

```yaml
backend:
  volumes:
    - uploads_shared:/app/uploads

volumes:
  uploads_shared:
    driver: local
    driver_opts:
      type: nfs
      o: addr=nfs-server.local,rw,nolock,soft
      device: ":/exports/uploads"
```

**Vantagens:**
- ‚úÖ Funciona em qualquer n√≥
- ‚úÖ Escal√°vel para m√∫ltiplos n√≥s
- ‚úÖ Mais robusto

**Desvantagens:**
- ‚ö†Ô∏è Requer configura√ß√£o adicional de NFS
- ‚ö†Ô∏è Pode ter impacto de performance

### üìù Recomenda√ß√£o Imediata

Como o ambiente atual √© single-node (servidor `servdocker`), **a Op√ß√£o A √© suficiente**.

**Nenhuma mudan√ßa √© necess√°ria por enquanto** se confirmarmos que:
- O Swarm roda sempre no mesmo host
- N√£o h√° planos de escalar para m√∫ltiplos n√≥s

**Pr√≥ximo passo:** Adicionar constraint para garantir consist√™ncia futura.

---

## üåê PONTO 2: CACHE NO NAVEGADOR

### ‚úÖ Status Atual

**Service Workers:** Nenhum configurado ‚úÖ
- O projeto usa `react-scripts` mas n√£o registra service workers
- Workbox est√° instalado como depend√™ncia transitiva mas n√£o √© usado
- N√£o h√° arquivos `sw.js` ou `worker.js`

**Versionamento de Assets:** Autom√°tico pelo react-scripts ‚úÖ
- O build do React gera hashes autom√°ticos: `main.9ac880ba.js`, `main.ecca091a.css`
- Cada deploy gera novos hashes, evitando cache residual

**Cache-Control:** Configurado no frontend ‚úÖ
- HTTP caching via Nginx (ver Dockerfile linha 31-53)
- Headers `Cache-Control: public, immutable` em arquivos est√°ticos

### ‚ö†Ô∏è Problemas Potenciais

1. **Configura√ß√£o de Nginx no container n√£o define cache explicitamente:**
   - O Dockerfile cria config inline sem cache headers
   - Depende da configura√ß√£o padr√£o do nginx:alpine

2. **Arquivos index.html podem ser cacheados:**
   - Sem headers anti-cache no index.html, navegadores podem servir vers√£o antiga
   - Especialmente problem√°tico ap√≥s deploy

### üîß Solu√ß√µes Recomendadas

#### **Ajuste 1: Adicionar headers de cache no Nginx do frontend**

Modificar `client/Dockerfile` para incluir cache headers mais expl√≠citos:

```dockerfile
# Ap√≥s linha 31, adicionar configura√ß√£o de cache
RUN echo '    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {' >> /etc/nginx/conf.d/default.conf && \
    echo '        expires 1y;' >> /etc/nginx/conf.d/default.conf && \
    echo '        add_header Cache-Control "public, immutable";' >> /etc/nginx/conf.d/default.conf && \
    echo '    }' >> /etc/nginx/conf.d/default.conf && \
    echo '' >> /etc/nginx/conf.d/default.conf && \
    echo '    # Desabilitar cache no index.html' >> /etc/nginx/conf.d/default.conf && \
    echo '    location = /index.html {' >> /etc/nginx/conf.d/default.conf && \
    echo '        add_header Cache-Control "no-cache, no-store, must-revalidate";' >> /etc/nginx/conf.d/default.conf && \
    echo '    }' >> /etc/nginx/conf.d/default.conf
```

**Vantagens:**
- ‚úÖ Evita cache residual do index.html
- ‚úÖ Mant√©m cache de assets est√°ticos para performance
- ‚úÖ N√£o impacta outras funcionalidades

**Desvantagens:**
- ‚ö†Ô∏è Ajuste manual no Dockerfile (linhas longas)

#### **Ajuste 2: Adicionar meta tags no index.html (Opcional)**

Adicionar tags anti-cache no `client/public/index.html`:

```html
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
```

**Nota:** Isso n√£o √© recomendado pois afeta a performance geral da p√°gina.

### üìù Recomenda√ß√£o

**Implementar Ajuste 1** para garantir que ap√≥s cada deploy, os usu√°rios sempre recebam a vers√£o mais recente.

**Nenhuma outra mudan√ßa necess√°ria** pois:
- Versionamento autom√°tico est√° funcionando
- Service workers n√£o est√£o ativos
- Assets j√° t√™m cache correto

---

## üîç PONTO 3: 404 AO VISUALIZAR PDF ASSINADO

### ‚úÖ Status Atual da Rota `/api/documents/:id/upload-signed`

**Localiza√ß√£o:** `server/index.js` linha 2638

**Comportamento atual:**
```javascript
// Linha 2668: Cria caminho absoluto
const signedPath = path.join(__dirname, 'uploads', signedFilename);

// Linha 2707-2709: Salva ABSOLUTO no signed_file_path
await pool.query(`
  UPDATE documents 
  SET signed_file_path = $1, signed_filename = $2, ...
`, [signedPath, signedFilename, documentId]);
```

### ‚ö†Ô∏è Problema Identificado

**Criticidade:** üü° M√âDIA

1. **Inconsist√™ncia no salvamento:**
   - `signed_file_path` recebe o caminho **absoluto** (`/app/uploads/signed_123.pdf`)
   - `signed_filename` recebe apenas o nome (`signed_123.pdf`)
   - Isso √© **inconsistente** mas **funciona** porque a leitura usa `signed_filename`

2. **Leitura correta:**
   - A rota `/api/documents/:id/stream` usa `signed_filename` corretamente (linha 1261)
   - J√° concatena com `__dirname + 'uploads'`

3. **O que pode causar 404:**
   - Se `signed_file_path` for usado em algum lugar esperando caminho absoluto
   - Se o arquivo n√£o estiver no volume correto ap√≥s container restart

### üîç An√°lise das Rotas de Leitura

**Rota de stream (linha 1241):**
```javascript
// Usa signed_filename (nome relativo) ‚úÖ
if (document.signed_filename && fs.existsSync(path.join(__dirname, 'uploads', document.signed_filename)))
```

**Rota de download (n√£o verificada):**
- Poss√≠vel que use `signed_file_path` incorretamente

### üîß Solu√ß√µes Recomendadas

#### **Corre√ß√£o Principal: Normalizar salvamento**

Alterar linha 2707-2709 de `server/index.js`:

**ANTES:**
```javascript
await pool.query(`
  UPDATE documents 
  SET signed_file_path = $1, signed_filename = $2, ...
`, [signedPath, signedFilename, documentId]);
```

**DEPOIS:**
```javascript
await pool.query(`
  UPDATE documents 
  SET signed_file_path = $1, signed_filename = $2, ...
`, [signedFilename, signedFilename, documentId]);  // Ambos com nome relativo
```

**Alternativa (melhor):**
```javascript
const relativePath = `signed/${documentId}/${signedFilename}`;
await pool.query(`
  UPDATE documents 
  SET signed_file_path = $1, signed_filename = $2, ...
`, [relativePath, signedFilename, documentId]);
```

**Vantagens:**
- ‚úÖ Consist√™ncia entre `signed_file_path` e `signed_filename`
- ‚úÖ Mais robusto para migrations futuras
- ‚úÖ Facilita organiza√ß√£o de arquivos

#### **Verifica√ß√£o Adicional: Buscar usos de signed_file_path**

Procurar em todo o c√≥digo onde `signed_file_path` √© utilizado:

```bash
grep -rn "signed_file_path" server/
```

### üìù Recomenda√ß√£o

**Implementar a corre√ß√£o** para garantir consist√™ncia e evitar problemas futuros.

**Pr√≥ximo passo:** Verificar se h√° outros lugares usando `signed_file_path` com caminho absoluto.

---

## üìä RESUMO EXECUTIVO

### ‚úÖ Nenhuma Altera√ß√£o Cr√≠tica Necess√°ria

Todos os 3 pontos analisados mostram que **o sistema est√° funcional**, mas com **melhorias recomendadas**.

### üéØ Prioridades

1. **ALTA:** Verificar usos de `signed_file_path` no c√≥digo
2. **M√âDIA:** Adicionar placement constraint no compose
3. **BAIXA:** Melhorar headers de cache no Nginx

### üö® A√ß√µes Imediatas Recomendadas

1. **Buscar usos de signed_file_path:**
   ```bash
   grep -rn "\.signed_file_path" server/
   ```

2. **Adicionar placement constraint** (se ambiente single-node):
   ```yaml
   # docker-compose.yml linha 42-45
   deploy:
     replicas: 1
     placement:
       constraints:
         - node.hostname == servdocker
     restart_policy:
       condition: any
   ```

3. **Corrigir salvamento do signed_file_path** para usar caminho relativo

4. **Melhorar cache headers** no Nginx do frontend

---

## üìã ARQUIVOS QUE PRECISAM SER MODIFICADOS

1. `docker-compose.yml` (linha 42-45): Adicionar placement constraint
2. `client/Dockerfile` (ap√≥s linha 31): Adicionar headers de cache
3. `server/index.js` (linha 2707-2709): Corrigir salvamento de path
4. Verificar outros arquivos onde `signed_file_path` √© usado

---

## ‚ö†Ô∏è IMPACTOS E RISCOS

### Riscos Baixos
- Cache headers: Apenas melhoria, n√£o quebra funcionalidade existente
- Placement constraint: N√£o impacta ambiente atual, apenas garante consist√™ncia

### Riscos M√©dios
- Altera√ß√£o de `signed_file_path`: Pode quebrar queries que dependem do formato absoluto
- Requer investiga√ß√£o completa antes de aplicar

---

## üß™ TESTES RECOMENDADOS

Ap√≥s implementar mudan√ßas:

1. **Upload de PDF assinado** ‚Üí Verificar persist√™ncia ap√≥s restart
2. **Download de PDF assinado** ‚Üí Verificar caminho correto
3. **Deploy completo** ‚Üí Verificar se arquivos persistem
4. **Hard refresh no navegador** ‚Üí Verificar se nova vers√£o carrega

---

**Gerado por:** Cursor AI Assistant
**Data:** 2025-01-29
**Vers√£o:** 1.0

